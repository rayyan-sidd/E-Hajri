<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Hazri</title>
    <link rel="icon" type="image/png" href="favicon.jpg">
    <meta name="theme-color" content="#4A90E2">
    <link rel="manifest" href="manifest.json">
    <style>
        /* General Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            overscroll-behavior-y: contain;
        }

        /* App Container */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            min-height: 100vh;
        }

        /* Header Styling */
        .header {
            background-color: #4A90E2;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        /* Page Content Styling */
        .page {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Button Styling */
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: white;
            background-color: #4A90E2;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background-color: #357ABD;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: #777;
        }

        .btn-secondary:hover {
            background-color: #555;
        }

        .btn-danger {
            background-color: #D9534F;
        }

        .btn-danger:hover {
            background-color: #C9302C;
        }

        /* Card Styling */
        .card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        /* Student List Styling */
        .student-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .student-list-item:last-child {
            border-bottom: none;
        }

        .student-list-item button {
            padding: 5px 10px;
            font-size: 0.9rem;
            width: auto;
            margin: 0;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4A90E2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        #loading-text {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #333;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Camera View Styling */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        video,
        canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Flip Camera Button Styling */
        .flip-camera-btn {
            display: none;
        }

        /* Hidden by default */

        /* Attendance List Styling */
        .attendance-status-list {
            margin-top: 20px;
        }

        .attendance-status-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .attendance-status-item.present {
            background-color: #d4edda;
            color: #155724;
        }

        .attendance-status-item.absent {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Sync Status Bar */
        #sync-status {
            background-color: #ffc107;
            color: #333;
            text-align: center;
            padding: 5px;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header">
            <h1>E-Hazri</h1>
            <p>Offline-First Rural School System</p>
        </div>

        <div id="sync-status">Syncing data to cloud...</div>

        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page active">
            <div class="card">
                <h2>Welcome, Teacher!</h2>
                <p>Manage your class attendance efficiently.</p>
            </div>
            <button class="btn" onclick="navigateTo('enroll')">Enroll New Student</button>
            <button class="btn" onclick="navigateTo('attendance')">Take Attendance</button>
            <button class="btn" onclick="navigateTo('reports')">View Reports</button>
            <button class="btn" onclick="navigateTo('manage')">Manage Students</button>
            <button class="btn btn-secondary" id="sync-button" onclick="syncData()">Sync Data to Cloud</button>
        </div>

        <!-- Enrollment Page -->
        <div id="page-enroll" class="page">
            <h2>Enroll New Student</h2>
            <div class="card">
                <div class="form-group"><label for="student-name">Student Name</label><input type="text"
                        id="student-name" placeholder="e.g. Priya Sharma"></div>
                <div class="form-group"><label for="roll-number">Roll Number</label><input type="text" id="roll-number"
                        placeholder="e.g. 25"></div>
                <p>Please take 3 clear photos of the student.</p>
                <div id="capture-status">Photos captured: 0 of 3</div>
                <div class="camera-container"><video id="enroll-video" autoplay muted playsinline></video></div>
                <button class="btn btn-secondary flip-camera-btn" onclick="flipCamera()">Flip Camera</button>
                <button class="btn" id="capture-btn" onclick="captureFace()">Capture Photo</button>
            </div>
            <button class="btn btn-secondary" onclick="navigateTo('dashboard')">Back to Dashboard</button>
        </div>

        <!-- Attendance Page -->
        <div id="page-attendance" class="page">
            <h2>Take Attendance</h2>
            <div class="card">
                <p>Pan your camera slowly across the classroom.</p>
                <div id="camera-container">
                    <video id="attendance-video" autoplay muted playsinline></video>
                    <canvas id="attendance-canvas"></canvas>
                </div>
                <button class="btn btn-secondary flip-camera-btn" onclick="flipCamera()">Flip Camera</button>
                <div id="attendance-status-list" class="attendance-status-list"></div>
            </div>
            <button class="btn" onclick="stopAttendanceScan()">Finish and Save</button>
            <button class="btn btn-secondary" onclick="navigateTo('dashboard')">Back to Dashboard</button>
        </div>

        <!-- Reports Page -->
        <div id="page-reports" class="page">
            <h2>Attendance Reports</h2>
            <div class="card">
                <div class="form-group"><label for="report-date">Select Date</label><input type="date" id="report-date">
                </div>
                <button class="btn" onclick="generateReport()">Generate Report</button>
                <div id="report-output"></div>
                <button class="btn btn-secondary" id="mid-day-meal-btn" onclick="generateMidDayMealReport()">Generate
                    Mid-Day Meal Report</button>
                <div id="mid-day-meal-output"></div>
            </div>
            <button class="btn btn-secondary" onclick="navigateTo('dashboard')">Back to Dashboard</button>
        </div>

        <!-- Manage Students Page -->
        <div id="page-manage" class="page">
            <h2>Manage Students</h2>
            <div class="card">
                <div id="student-management-list"></div>
            </div>
            <button class="btn btn-secondary" onclick="navigateTo('dashboard')">Back to Dashboard</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">Loading AI Models...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const videoEnroll = document.getElementById('enroll-video');
        const videoAttendance = document.getElementById('attendance-video');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        let db, faceMatcher, attendanceInterval;
        let studentData = [];
        let capturedDescriptors = [];
        let currentFacingMode = 'environment'; // Default to back camera

        window.onload = async () => {
            setupDatabase();
            await loadFaceApiModels();
            await loadStudentData();
            checkCameraCapabilities();
            navigateTo('dashboard');
            hideLoading();
            registerServiceWorker();
        };

        function showLoading(text) {
            loadingText.innerText = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        async function loadFaceApiModels() {
            showLoading('Loading AI Models...');
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./models'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./models')
            ]);
            console.log("AI Models Loaded");
        }

        function setupDatabase() {
            db = new Dexie("SchoolAttendanceDB");
            db.version(1).stores({
                students: '++id, name, &rollNumber',
                faceData: '++id, studentId',
                attendance: '++id, [date+studentId], status'
            });
            console.log("Database Setup Complete");
        }

        async function loadStudentData() {
            showLoading('Loading Student Data...');
            studentData = await db.students.toArray();
            const labeledFaceDescriptors = await Promise.all(
                studentData.map(async (student) => {
                    const faceRecords = await db.faceData.where('studentId').equals(student.id).toArray();
                    const descriptors = faceRecords.map(record => new Float32Array(Object.values(record.descriptor)));
                    if (descriptors.length > 0) {
                        return new faceapi.LabeledFaceDescriptors(student.name, descriptors);
                    }
                })
            );
            const validDescriptors = labeledFaceDescriptors.filter(d => d);
            faceMatcher = validDescriptors.length > 0 ? new faceapi.FaceMatcher(validDescriptors, 0.5) : null;
            console.log(`Face Matcher ready for ${validDescriptors.length} students.`);
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            stopAllCameras();
            if (page === 'enroll') { startCamera(videoEnroll); resetEnrollmentForm(); }
            else if (page === 'attendance') { startAttendanceScan(); }
            else if (page === 'reports') { document.getElementById('report-date').valueAsDate = new Date(); }
            else if (page === 'manage') { displayStudentManagementList(); }
        }

        async function startCamera(videoElement) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                videoElement.srcObject = stream;
            } catch (err) {
                console.error("Camera Error:", err);
                alert("Could not access camera. Please check permissions and try again.");
            }
        }

        function stopAllCameras() {
            [videoEnroll, videoAttendance].forEach(video => {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
            });
            clearInterval(attendanceInterval);
        }

        // --- FLIP CAMERA LOGIC ---
        async function checkCameraCapabilities() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                if (devices.filter(d => d.kind === 'videoinput').length > 1) {
                    document.querySelectorAll('.flip-camera-btn').forEach(btn => btn.style.display = 'block');
                }
            } catch (e) { console.error("Could not check cameras:", e); }
        }

        async function flipCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            stopAllCameras(); // Stop the current stream

            // Restart the camera for the currently active page
            if (document.getElementById('page-enroll').classList.contains('active')) {
                await startCamera(videoEnroll);
            } else if (document.getElementById('page-attendance').classList.contains('active')) {
                await startAttendanceScan();
            }
        }

        // --- STUDENT ENROLLMENT ---
        function resetEnrollmentForm() {
            document.getElementById('student-name').value = '';
            document.getElementById('roll-number').value = '';
            capturedDescriptors = [];
            document.getElementById('capture-status').innerText = 'Photos captured: 0 of 3';
        }

        async function captureFace() {
            if (capturedDescriptors.length >= 3) return;
            const detection = await faceapi.detectSingleFace(videoEnroll, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (detection) {
                capturedDescriptors.push(detection.descriptor);
                document.getElementById('capture-status').innerText = `Photos captured: ${capturedDescriptors.length} of 3`;
                if (capturedDescriptors.length === 3) await saveStudent();
            } else { alert("No face detected. Please try again."); }
        }

        async function saveStudent() {
            const name = document.getElementById('student-name').value.trim();
            const rollNumber = document.getElementById('roll-number').value.trim();
            if (!name || !rollNumber) return alert("Please fill all fields.");

            showLoading("Saving Student...");
            try {
                await db.transaction('rw', db.students, db.faceData, async () => {
                    const existing = await db.students.where('rollNumber').equals(rollNumber).first();
                    if (existing) throw new Error(`Student with Roll No ${rollNumber} already exists.`);
                    const studentId = await db.students.add({ name, rollNumber });
                    await db.faceData.bulkAdd(capturedDescriptors.map(d => ({ studentId, descriptor: d })));
                });
                alert(`Student ${name} enrolled!`);
                await loadStudentData();
                navigateTo('dashboard');
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally { hideLoading(); }
        }

        // --- ATTENDANCE LOGIC ---
        async function startAttendanceScan() {
            const attendanceList = document.getElementById('attendance-status-list');
            attendanceList.innerHTML = '';
            studentData.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.id = `status-${student.id}`;
                studentDiv.className = 'attendance-status-item absent';
                studentDiv.innerHTML = `<span>${student.name}</span><span id="label-${student.id}">Absent</span>`;
                attendanceList.appendChild(studentDiv);
            });
            await startCamera(videoAttendance); // Wait for camera to start before setting up canvas
            const canvas = document.getElementById('attendance-canvas');
            attendanceInterval = setInterval(async () => {
                if (!faceMatcher || videoAttendance.readyState < 2) return;
                const displaySize = { width: videoAttendance.clientWidth, height: videoAttendance.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);
                const detections = await faceapi.detectAllFaces(videoAttendance, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                results.forEach(result => {
                    if (result.label !== 'unknown') {
                        const student = studentData.find(s => s.name === result.label);
                        if (student) markStudentPresent(student.id);
                    }
                });
            }, 1000);
        }

        function markStudentPresent(studentId) {
            const studentDiv = document.getElementById(`status-${studentId}`);
            if (studentDiv && studentDiv.classList.contains('absent')) {
                studentDiv.classList.replace('absent', 'present');
                document.getElementById(`label-${studentId}`).innerText = 'Present';
            }
        }

        async function stopAttendanceScan() {
            stopAllCameras();
            showLoading("Saving Attendance...");
            const today = new Date().toISOString().slice(0, 10);
            try {
                await db.transaction('rw', db.attendance, async () => {
                    await db.attendance.where({ date: today }).delete();
                    const records = [];
                    document.querySelectorAll('.attendance-status-item').forEach(item => {
                        records.push({
                            date: today,
                            studentId: parseInt(item.id.split('-')[1]),
                            status: item.classList.contains('present') ? 'Present' : 'Absent'
                        });
                    });
                    await db.attendance.bulkAdd(records);
                });
                alert("Attendance saved!");
                navigateTo('dashboard');
            } catch (e) { alert("Failed to save attendance."); }
            finally { hideLoading(); }
        }

        // --- REPORTS & MANAGEMENT ---
        async function generateReport() {
            const date = document.getElementById('report-date').value;
            if (!date) return alert("Please select a date.");
            const records = await db.attendance.where('date').equals(date).toArray();
            const reportOutput = document.getElementById('report-output');
            if (records.length === 0) return reportOutput.innerHTML = `<p>No records for ${date}.</p>`;
            let html = `<h4>Report for ${date}</h4><ul>`;
            for (const r of records) {
                const student = studentData.find(s => s.id === r.studentId);
                if (student) html += `<li>${student.name} (Roll: ${student.rollNumber}) - <strong>${r.status}</strong></li>`;
            }
            reportOutput.innerHTML = html + '</ul>';
        }

        async function generateMidDayMealReport() {
            const date = document.getElementById('report-date').value;
            if (!date) return alert("Please select a date.");
            const count = await db.attendance.where({ date, status: 'Present' }).count();
            document.getElementById('mid-day-meal-output').innerHTML = `<p class="card"><strong>Meal Report for ${date}:</strong><br> Total present: <strong>${count}</strong></p>`;
        }

        // --- FIX: This is the robust method for creating the student list ---
        async function displayStudentManagementList() {
            const listContainer = document.getElementById('student-management-list');
            listContainer.innerHTML = '';
            const allStudents = await db.students.toArray();
            if (allStudents.length === 0) {
                listContainer.innerHTML = '<p>No students enrolled yet.</p>';
                return;
            }
            allStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-list-item';
                const info = document.createElement('span');
                info.textContent = `${student.name} (Roll: ${student.rollNumber})`;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger';
                removeBtn.textContent = 'Remove';
                // Using addEventListener is the key fix that works everywhere
                removeBtn.addEventListener('click', () => removeStudent(student.id, student.name));
                item.append(info, removeBtn);
                listContainer.appendChild(item);
            });
        }

        async function removeStudent(studentId, studentName) {
            if (!confirm(`Are you sure you want to remove ${studentName}? This is permanent.`)) return;
            showLoading(`Removing ${studentName}...`);
            try {
                await db.transaction('rw', db.students, db.faceData, db.attendance, async () => {
                    await db.faceData.where({ studentId }).delete();
                    await db.attendance.where({ studentId }).delete();
                    await db.students.where({ studentId }).delete(studentId);
                });
                alert(`${studentName} removed successfully.`);
                await loadStudentData(); // Reload student data for face matcher
                await displayStudentManagementList(); // Re-render the list on the page
            } catch (error) {
                console.error(`Failed to remove student:`, error);
                alert(`Error removing student. See console for details.`);
            } finally { hideLoading(); }
        }

        // --- PWA SERVICE WORKER ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }
        }

        async function syncData() {
            document.getElementById('sync-status').style.display = 'block';
            showLoading("Syncing with cloud...");
            setTimeout(() => {
                document.getElementById('sync-status').style.display = 'none';
                hideLoading();
                alert("Data synced successfully (simulation)!");
            }, 2000);
        }
    </script>
</body>

</html>